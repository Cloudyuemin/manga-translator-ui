# 翻译字典

<cite>
**本文档中引用的文件**  
- [pre_dict.txt](file://dict/pre_dict.txt)
- [post_dict.txt](file://dict/post_dict.txt)
- [generic.py](file://manga_translator/utils/generic.py)
- [manga_translator.py](file://manga_translator/manga_translator.py)
</cite>

## 目录
1. [简介](#简介)
2. [预处理与后处理字典的作用](#预处理与后处理字典的作用)
3. [字典文件格式规范](#字典文件格式规范)
4. [字典加载与匹配逻辑](#字典加载与匹配逻辑)
5. [匹配优先级与正则表达式支持](#匹配优先级与正则表达式支持)
6. [创建高效翻译字典的实用技巧](#创建高效翻译字典的实用技巧)
7. [总结](#总结)

## 简介
在漫画图像翻译流程中，`pre_dict.txt`（预处理字典）和`post_dict.txt`（后处理字典）是两个关键的文本替换工具，用于提升翻译的准确性与一致性。`pre_dict`在原文送入翻译引擎前进行标准化处理，而`post_dict`则在译文生成后进行修正与优化。本文档将深入解析这两个字典的作用、格式、加载逻辑及最佳实践。

## 预处理与后处理字典的作用

### 预处理字典 (pre_dict.txt)
`pre_dict.txt`在翻译流程的**前端**发挥作用。其主要任务是在原始文本被送入翻译模型（如GPT、Sakura等）之前，对文本进行预处理。这种预处理可以包括：
- **缩写展开**：将“NTR”替换为“Netorare”，确保翻译模型理解其完整含义。
- **术语统一**：将不同写法的同一术语（如“萌え”、“moe”）统一为标准形式，避免翻译歧义。
- **特殊符号处理**：将日文中的特殊标点或符号替换为更通用的形式，以提高OCR识别和翻译的准确性。

通过`pre_dict`的预处理，可以确保翻译引擎接收到的是一个更清晰、更规范的输入，从而提高翻译质量。

### 后处理字典 (post_dict.txt)
`post_dict.txt`在翻译流程的**后端**发挥作用。其主要任务是在翻译引擎生成译文后，对输出结果进行修正。这种后处理可以包括：
- **专有名词校正**：确保角色名（如“野比大雄”）、地名、组织名等专有名词的翻译完全一致，不受翻译模型随机性的影响。
- **表达优化**：将机器翻译中生硬或不自然的表达替换为更符合目标语言习惯的表达。
- **格式标准化**：统一数字、日期、单位等的显示格式。

`post_dict`充当了翻译质量的“最后一道防线”，确保最终输出的译文在术语和风格上保持高度一致。

**Section sources**
- [pre_dict.txt](file://dict/pre_dict.txt)
- [post_dict.txt](file://dict/post_dict.txt)

## 字典文件格式规范
`pre_dict.txt`和`post_dict.txt`遵循相同的格式规范，这是一种被称为MIT格式的简单文本格式。

### 基本格式
每一行代表一个替换规则，格式如下：
```
源词[至少一个Tab/空格]目标词[至少一个Tab/空格][#注释 或 //注释]
```
- **源词 (Source Term)**：需要被替换的原始文本。它可以是普通字符串，也可以是正则表达式。
- **分隔符**：源词和目标词之间必须使用**制表符(Tab)**或**一个或多个空格**进行分隔。代码中会优先尝试用Tab分割，如果失败则尝试用空格。
- **目标词 (Target Term)**：用于替换源词的文本。在目标词中，可以使用`$1`, `$2`等来引用正则表达式中的捕获组。
- **注释 (Comment)**：可选部分，以`#`或`//`开头，用于解释该条目的用途。

### 示例分析
以`pre_dict.txt`中的条目为例：
```
第([0-9]+)话	Episode $1	# 匹配集数
```
- **源词**：`第([0-9]+)话` 是一个正则表达式，其中`([0-9]+)`表示一个或多个数字，并被括号捕获。
- **分隔符**：一个制表符。
- **目标词**：`Episode $1`，其中`$1`会被正则表达式匹配到的数字部分所替换。
- **效果**：当原文为“第1话”时，`pre_dict`会将其替换为“Episode 1”，然后再送入翻译引擎。

**Section sources**
- [pre_dict.txt](file://dict/pre_dict.txt)
- [post_dict.txt](file://dict/post_dict.txt)

## 字典加载与匹配逻辑
字典的加载和应用逻辑主要在`manga_translator.py`和`generic.py`中实现。

### 加载过程
1.  **文件读取**：程序读取`pre_dict.txt`和`post_dict.txt`文件的每一行。
2.  **行处理**：对于每一行，首先移除注释（`#`或`//`之后的内容）并去除首尾空白。
3.  **分割字段**：使用`split()`方法尝试用空格或制表符分割行内容。如果分割后得到两个部分，则认为是有效的`源词`和`目标词`。
4.  **编译正则表达式**：将`源词`字符串编译成一个Python的`re.Pattern`对象。这使得字典不仅支持精确匹配，还支持强大的正则表达式匹配。
5.  **构建字典列表**：将编译好的正则表达式对象、目标词字符串以及行号作为一个元组，存入一个列表中。最终，`pre_dict`和`post_dict`都变成了一个由`(pattern, replacement, line_number)`元组组成的列表。

```python
def load_replacement_dict(filepath: str) -> List[Tuple[re.Pattern, str, int]]:
    dictionary = []
    if filepath and os.path.exists(filepath):
        with open(filepath, 'r', encoding='utf-8') as file:
            for line_number, line in enumerate(file, start=1):
                line = line.strip()
                if not line or line.startswith('#') or line.startswith('//'):
                    continue
                # 移除注释
                line = line.split('#')[0].strip()
                line = line.split('//')[0].strip()
                parts = line.split()
                if len(parts) == 2:
                    pattern = re.compile(parts[0])
                    dictionary.append((pattern, parts[1], line_number))
    return dictionary
```

### 应用过程
字典的应用是通过`apply_dictionary`函数完成的，该函数遍历字典列表中的每一个规则，并按顺序应用。

```python
def apply_dictionary(text, dictionary):
    for pattern, value, line_number in dictionary:
        original_text = text  
        text = pattern.sub(value, text)  # 执行替换
        if text != original_text:  # 如果发生了替换
            logger.info(f'第{line_number}行: 使用模式"{pattern.pattern}"将"{original_text}"替换为"{text}"')
    return text
```

在主翻译流程中，这两个字典被依次调用：
```python
# 伪代码表示的翻译流程
translated_text = apply_dictionary(original_text, pre_dict)  # 1. 预处理
translated_text = translator_engine.translate(translated_text)  # 2. 调用翻译引擎
translated_text = apply_dictionary(translated_text, post_dict)  # 3. 后处理
```

**Section sources**
- [generic.py](file://manga_translator/utils/generic.py#L74-L104)
- [manga_translator.py](file://manga_translator/manga_translator.py#L86-L88)

## 匹配优先级与正则表达式支持
### 匹配优先级
字典的匹配遵循**严格的顺序优先级**。规则按照它们在字典文件中出现的**从上到下的顺序**进行应用。这意味着：
- **位置靠前的规则优先级更高**。如果一个文本片段可以匹配多条规则，只有最先匹配到的那条规则会被执行。
- 这种设计允许用户通过调整条目的顺序来控制替换的优先级。例如，可以先定义更具体的规则，再定义更通用的规则。

### 正则表达式支持
字典的核心优势在于其对**正则表达式**的原生支持。这极大地扩展了其功能：
- **动态匹配**：如`第([0-9]+)话`可以匹配任意集数。
- **模式替换**：利用捕获组`()`和反向引用`$1`, `$2`等，可以实现复杂的文本重构。
- **条件匹配**：可以使用`|`（或）、`?`（可选）、`*`（零次或多次）等操作符构建复杂的匹配条件。

**Section sources**
- [pre_dict.txt](file://dict/pre_dict.txt)
- [generic.py](file://manga_translator/utils/generic.py#L74-L104)

## 创建高效翻译字典的实用技巧
为了最大化翻译字典的效果，遵循以下最佳实践至关重要：

### 1. 明确区分预处理与后处理
- **`pre_dict`**：专注于**输入标准化**。用于处理原文中的缩写、变体、特殊符号等，让翻译引擎更容易理解。
- **`post_dict`**：专注于**输出校正**。用于确保译文中的专有名词、术语和表达完全符合预期。

### 2. 合理利用正则表达式
- **避免过度复杂**：虽然正则表达式功能强大，但过于复杂的表达式可能难以维护且影响性能。优先使用简单的字符串匹配。
- **测试你的正则**：在将复杂的正则表达式加入字典前，务必在独立的测试环境中验证其正确性。

### 3. 精心设计匹配顺序
- **从具体到一般**：将更具体、更精确的规则放在前面，更通用的规则放在后面。例如，先替换“工藤新一”，再替换“主角”。
- **考虑规则间的相互影响**：确保一条规则的输出不会意外地触发另一条不期望的规则。

### 4. 充分利用注释
- 在每条规则后添加清晰的注释（`#`或`//`），说明其用途、来源或上下文。这对于团队协作和后期维护至关重要。

### 5. 保持字典的模块化和可维护性
- 对于大型项目，可以考虑将字典按主题（如“角色名”、“术语”、“集数格式”）拆分成多个文件，然后在配置中指定主字典文件。

### 示例：构建一个高效的字典
```txt
# === 预处理字典 (pre_dict.txt) ===
# 统一术语
萌え	moe
NTR	Netorare

# 标准化集数格式
第([0-9]+)话	Episode $1

# === 后处理字典 (post_dict.txt) ===
# 校正角色名
Nobita Nobi	野比大雄
Shizuka Minamoto	源静香
Ai Haibara	灰原哀

# 优化表达
Burning/Hype	热血沸腾
Moe-fication	萌化
```

## 总结
`pre_dict.txt`和`post_dict.txt`是漫画翻译流程中不可或缺的工具。通过在翻译前后进行精准的文本替换，它们有效解决了机器翻译在术语一致性、专有名词处理和表达自然度方面的固有缺陷。理解其基于MIT格式的简单结构、按行顺序执行的匹配逻辑以及强大的正则表达式支持，是创建高效、可靠翻译字典的关键。遵循最佳实践，精心维护这两个字典，可以显著提升最终翻译作品的质量和专业性。