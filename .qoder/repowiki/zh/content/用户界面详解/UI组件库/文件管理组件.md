# 文件管理组件

<cite>
**本文档引用的文件**   
- [file_list_frame.py](file://desktop-ui/components/file_list_frame.py)
- [file_manager.py](file://desktop-ui/components/file_manager.py)
- [file_service.py](file://desktop-ui/services/file_service.py)
- [state_manager.py](file://desktop-ui/services/state_manager.py)
</cite>

## 目录
1. [项目结构](#项目结构)
2. [核心组件](#核心组件)
3. [文件列表框架分析](#文件列表框架分析)
4. [文件管理器分析](#文件管理器分析)
5. [文件服务与状态管理](#文件服务与状态管理)
6. [依赖关系分析](#依赖关系分析)

## 项目结构
本项目为一个漫画图像翻译工具的桌面UI组件集合，主要包含核心功能模块、用户界面组件、服务层和工具类。其中，`desktop-ui/components/`目录下包含了文件管理相关的UI组件，如`file_list_frame.py`和`file_manager.py`；`desktop-ui/services/`目录则提供了文件操作、状态管理等底层服务。

```mermaid
graph TD
subgraph "UI Components"
FileListFrame["file_list_frame.py<br/>文件列表UI"]
FileManager["file_manager.py<br/>文件管理逻辑"]
end
subgraph "Services"
FileService["file_service.py<br/>文件操作服务"]
StateManager["state_manager.py<br/>状态管理器"]
ConfigService["config_service.py<br/>配置服务"]
end
FileListFrame --> FileService
FileListFrame --> StateManager
FileManager --> FileService
FileManager --> StateManager
FileManager --> ConfigService
```

**图示来源**
- [file_list_frame.py](file://desktop-ui/components/file_list_frame.py)
- [file_manager.py](file://desktop-ui/components/file_manager.py)
- [file_service.py](file://desktop-ui/services/file_service.py)
- [state_manager.py](file://desktop-ui/services/state_manager.py)

**本节来源**
- [file_list_frame.py](file://desktop-ui/components/file_list_frame.py)
- [file_manager.py](file://desktop-ui/components/file_manager.py)

## 核心组件
系统的核心文件管理功能由两个主要类构成：`FileListFrame`负责用户界面展示与交互，`FileManager`负责实际的文件加载与数据读取。两者通过回调函数和全局状态管理器进行通信，实现了UI与业务逻辑的分离。

**本节来源**
- [file_list_frame.py](file://desktop-ui/components/file_list_frame.py#L1-L115)
- [file_manager.py](file://desktop-ui/components/file_manager.py#L1-L121)

## 文件列表框架分析
`FileListFrame`类实现了可滚动的文件列表界面，支持添加单个文件或整个文件夹，并允许用户选择和移除文件。

### 功能特性
- **文件添加**：通过“添加图片”和“添加文件夹”按钮触发外部回调函数
- **缩略图显示**：使用PIL库生成40x40像素的缩略图
- **条目选择**：点击文件条目时高亮显示并通知父组件
- **文件移除**：每个条目右侧有“✕”按钮用于移除文件
- **列表清空**：提供“清空列表”按钮批量移除所有文件

```mermaid
classDiagram
class FileListFrame {
+on_file_select : Callable[[str], None]
+on_load_files : Callable
+on_load_folder : Callable
+on_file_unload : Callable[[str], None]
+on_clear_list_requested : Callable[[], None]
+file_paths : List[str]
+current_selection : Optional[CTkFrame]
+file_frames : Dict[str, CTkFrame]
+__init__(parent, on_file_select, on_load_files, on_load_folder, on_file_unload, on_clear_list_requested)
+add_files(file_paths : List[str])
+_add_file_entry(file_path : str)
+_on_entry_click(file_path : str, frame : CTkFrame)
+_on_unload_file(file_path : str)
+remove_file(file_path : str)
+clear_files()
}
FileListFrame --> ctk.CTkFrame : "继承"
```

**图示来源**
- [file_list_frame.py](file://desktop-ui/components/file_list_frame.py#L1-L115)

**本节来源**
- [file_list_frame.py](file://desktop-ui/components/file_list_frame.py#L1-L115)

## 文件管理器分析
`FileManager`类负责处理图像文件和关联JSON数据的加载，是连接UI与数据存储的关键组件。

### 主要功能
- **图像加载**：安全地打开图像文件并触发回调
- **JSON数据读取**：加载与图像同名的`_translations.json`文件
- **配置回退**：当JSON中缺少目标语言时，使用全局配置作为默认值
- **蒙版解码**：支持Base64编码和旧版数组格式的蒙版数据

```mermaid
classDiagram
class FileManager {
+current_file_path : Optional[str]
+image_loaded_callback : Optional[callable]
+config_service : ConfigService
+__init__()
+register_callback(name : str, callback : callable)
+load_image_from_path(file_path : str)
+load_json_data(image_path : str) -> Tuple[List[Dict], Optional[np.ndarray], Optional[Tuple[int, int]]]
}
FileManager --> ConfigService : "使用"
```

**图示来源**
- [file_manager.py](file://desktop-ui/components/file_manager.py#L1-L121)

**本节来源**
- [file_manager.py](file://desktop-ui/components/file_manager.py#L1-L121)

## 文件服务与状态管理
文件操作和应用状态由专门的服务类统一管理，确保了系统的可维护性和扩展性。

### 文件服务（FileService）
提供文件验证、批量处理、拖拽支持等基础功能：
- 验证图片和配置文件的有效性
- 从文件夹递归获取所有支持的图片文件
- 处理拖拽操作中的文件路径解析
- 支持多种图片格式（PNG, JPG, WEBP等）

### 状态管理器（StateManager）
实现响应式状态管理，支持状态订阅机制：
- 使用枚举`AppStateKey`定义所有状态键
- 提供线程安全的状态读写操作
- 支持状态变化的观察者模式
- 维护当前文件列表、选中文件、翻译进度等关键状态

```mermaid
classDiagram
class FileService {
+supported_image_extensions : Set[str]
+supported_config_extensions : Set[str]
+validate_image_file(file_path : str) bool
+validate_config_file(file_path : str) bool
+get_image_files_from_folder(folder_path : str, recursive : bool) List[str]
+filter_valid_image_files(file_paths : List[str]) List[str]
+process_dropped_files(dropped_data : str) Tuple[List[str], List[str]]
+_parse_drop_data(dropped_data : str) List[str]
+get_file_info(file_path : str) dict
}
class StateManager {
+_state : Dict[AppStateKey, Any]
+_observers : Dict[AppStateKey, List[Callable[[Any], None]]]
+get_state(key : AppStateKey) Any
+set_state(key : AppStateKey, value : Any, notify : bool)
+subscribe(key : AppStateKey, callback : Callable[[Any], None])
+_notify_observers(key : AppStateKey, new_value : Any, old_value : Any)
+get_current_files() List[str]
+set_current_files(files : List[str])
+get_selected_files() List[str]
+set_selected_files(files : List[str])
}
class AppStateKey {
+IS_TRANSLATING
+TRANSLATION_PROGRESS
+CURRENT_FILES
+SELECTED_FILES
+APP_READY
+ERROR_MESSAGES
}
FileListFrame --> FileService : "使用"
FileListFrame --> StateManager : "同步"
FileManager --> StateManager : "读取配置"
FileManager --> FileService : "验证文件"
```

**图示来源**
- [file_service.py](file://desktop-ui/services/file_service.py#L1-L274)
- [state_manager.py](file://desktop-ui/services/state_manager.py#L1-L251)

**本节来源**
- [file_service.py](file://desktop-ui/services/file_service.py#L1-L274)
- [state_manager.py](file://desktop-ui/services/state_manager.py#L1-L251)

## 依赖关系分析
系统各组件之间通过清晰的接口进行交互，形成了松耦合的架构。

```mermaid
graph TD
A[FileListFrame] --> B[FileService]
A --> C[StateManager]
D[FileManager] --> B
D --> C
D --> E[ConfigService]
C --> F[AppStateKey]
B --> G[Image]
B --> H[mimetypes]
D --> I[json]
D --> J[base64]
D --> K[cv2]
style A fill:#f9f,stroke:#333
style D fill:#f9f,stroke:#333
style B fill:#bbf,stroke:#333
style C fill:#bbf,stroke:#333
```

**图示来源**
- [file_list_frame.py](file://desktop-ui/components/file_list_frame.py)
- [file_manager.py](file://desktop-ui/components/file_manager.py)
- [file_service.py](file://desktop-ui/services/file_service.py)
- [state_manager.py](file://desktop-ui/services/state_manager.py)

**本节来源**
- [file_list_frame.py](file://desktop-ui/components/file_list_frame.py)
- [file_manager.py](file://desktop-ui/components/file_manager.py)
- [file_service.py](file://desktop-ui/services/file_service.py)
- [state_manager.py](file://desktop-ui/services/state_manager.py)