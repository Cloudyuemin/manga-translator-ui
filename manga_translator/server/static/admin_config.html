<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å‚æ•°é…ç½®ç®¡ç† - Admin Panel</title>
    <link rel="stylesheet" href="/static/style.css">
    <style>
        body { overflow: auto !important; }
        .config-container {
            max-width: 1400px;
            margin: 20px auto;
            padding: 20px;
        }
        .config-section {
            background: white;
            border: 1px solid #E0E0E0;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .config-section h2 {
            color: #2196F3;
            margin-bottom: 15px;
            font-size: 18px;
        }
        .param-list {
            display: grid;
            gap: 10px;
        }
        .param-item {
            display: grid;
            grid-template-columns: 280px 100px 1fr 200px;
            gap: 12px;
            align-items: center;
            padding: 12px;
            border: 1px solid #E0E0E0;
            border-radius: 4px;
            background: #F5F7FA;
            margin-bottom: 8px;
        }
        .param-item.editing {
            background: #E3F2FD;
            border-color: #2196F3;
        }
        .param-item.hidden {
            opacity: 0.6;
            background: #FFEBEE;
        }
        .param-item.readonly {
            background: #FFF9C4;
        }
        .param-name {
            font-weight: 500;
            color: #2C3E50;
        }
        .param-type {
            color: #666;
            font-size: 12px;
        }
        .param-value {
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 13px;
            color: #1976D2;
            cursor: pointer;
            padding: 6px 10px;
            border-radius: 4px;
            background: white;
            border: 1px solid #CFD8DC;
            word-break: break-all;
            transition: all 0.2s;
            min-height: 32px;
            display: flex;
            align-items: center;
        }
        .param-value:hover {
            background: #E3F2FD;
            border-color: #2196F3;
            box-shadow: 0 2px 4px rgba(33, 150, 243, 0.2);
        }
        .param-value-edit {
            width: 100%;
            padding: 4px 8px;
            border: 2px solid #2196F3;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
        }
        .param-value-select {
            width: 100%;
            padding: 6px 10px;
            border: 1px solid #CFD8DC;
            border-radius: 4px;
            font-size: 13px;
            cursor: pointer;
            background: white;
            transition: all 0.2s;
        }
        .param-value-select:hover {
            border-color: #2196F3;
            box-shadow: 0 2px 4px rgba(33, 150, 243, 0.2);
        }
        .param-value-select:focus {
            outline: none;
            border-color: #2196F3;
            box-shadow: 0 0 0 3px rgba(33, 150, 243, 0.1);
        }
        .param-controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        .param-controls label {
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 5px;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 4px;
            background: white;
            border: 1px solid #E0E0E0;
            transition: all 0.2s;
        }
        .param-controls label:hover {
            background: #F5F5F5;
            border-color: #2196F3;
        }
        .param-controls input[type="checkbox"] {
            cursor: pointer;
        }
        .section-controls {
            display: flex;
            gap: 8px;
            margin-bottom: 15px;
            padding: 12px;
            background: #E3F2FD;
            border-radius: 6px;
            flex-wrap: wrap;
        }
        .section-controls button {
            padding: 6px 14px;
            font-size: 12px;
            border: 1px solid #90CAF9;
        }
        .section-controls button:hover {
            background: #BBDEFB;
        }
        .param-list-header {
            display: grid;
            grid-template-columns: 280px 100px 1fr 200px;
            gap: 12px;
            padding: 8px 12px;
            background: #ECEFF1;
            border-radius: 4px;
            margin-bottom: 10px;
            font-weight: 600;
            font-size: 13px;
            color: #546E7A;
        }
        .save-btn {
            position: fixed;
            bottom: 30px;
            right: 30px;
            padding: 15px 30px;
            font-size: 16px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        .save-btn:hover {
            background: #45a049;
        }
        .back-btn {
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="config-container">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <button onclick="window.location.href='/admin'" class="secondary-btn back-btn">â† è¿”å›ç®¡ç†é¢æ¿</button>
            <select id="language-select" class="language-select" onchange="changeLanguage(this.value)">
                <option value="zh_CN">ç®€ä½“ä¸­æ–‡</option>
                <option value="zh_TW">ç¹é«”ä¸­æ–‡</option>
                <option value="en_US">English</option>
                <option value="ja_JP">æ—¥æœ¬èª</option>
                <option value="ko_KR">í•œêµ­ì–´</option>
                <option value="es_ES">EspaÃ±ol</option>
            </select>
        </div>
        
        <h1 style="color: #2196F3; margin-bottom: 20px;">å‚æ•°é…ç½®ç®¡ç†</h1>
        <p style="color: #666; margin-bottom: 10px;">ç²¾ç¡®æ§åˆ¶æ¯ä¸ªå‚æ•°çš„å¯è§æ€§ã€åªè¯»çŠ¶æ€å’Œé»˜è®¤å€¼</p>
        
        <div style="background: #E3F2FD; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
            <h3 style="margin-bottom: 10px; color: #1976D2;">ä½¿ç”¨è¯´æ˜ï¼š</h3>
            <ul style="margin-left: 20px; line-height: 1.8;">
                <li><strong>ç‚¹å‡»å‚æ•°å€¼</strong>å¯ä»¥ç›´æ¥ç¼–è¾‘ï¼ˆæŒ‰ Enter ä¿å­˜ï¼ŒEsc å–æ¶ˆï¼‰</li>
                <li><strong>éšè—</strong>ï¼šç”¨æˆ·ç«¯å®Œå…¨çœ‹ä¸åˆ°è¯¥å‚æ•°</li>
                <li><strong>åªè¯»</strong>ï¼šç”¨æˆ·ç«¯å¯ä»¥çœ‹åˆ°ä½†ä¸èƒ½ä¿®æ”¹</li>
                <li>ä¿®æ”¹åçš„å€¼ä¼šä½œä¸ºæ–°çš„é»˜è®¤å€¼æä¾›ç»™ç”¨æˆ·ç«¯</li>
                <li>ä½¿ç”¨åŒºåŸŸæ§åˆ¶æŒ‰é’®å¯ä»¥æ‰¹é‡è®¾ç½®æ•´ä¸ªåŒºåŸŸçš„å‚æ•°</li>
            </ul>
            <div style="margin-top: 10px; display: flex; gap: 15px; font-size: 13px;">
                <span>ğŸ”´ <span style="background: #FFEBEE; padding: 2px 8px; border-radius: 3px;">çº¢è‰²èƒŒæ™¯ = å·²éšè—</span></span>
                <span>ğŸŸ¡ <span style="background: #FFF9C4; padding: 2px 8px; border-radius: 3px;">é»„è‰²èƒŒæ™¯ = åªè¯»</span></span>
                <span>ğŸ”µ <span style="background: #E3F2FD; padding: 2px 8px; border-radius: 3px;">è“è‰²è¾¹æ¡† = æ­£åœ¨ç¼–è¾‘</span></span>
            </div>
        </div>
        
        <div id="config-sections"></div>
        
        <button onclick="saveAllSettings()" class="save-btn">ğŸ’¾ ä¿å­˜æ‰€æœ‰è®¾ç½®</button>
    </div>

    <script>
        let adminToken = localStorage.getItem('adminToken');
        let configStructure = {};
        let currentSettings = {
            hidden_keys: [],
            readonly_keys: [],
            default_values: {}
        };
        let i18nData = {};
        let currentLocale = localStorage.getItem('locale') || 'zh_CN';

        // i18n åŠŸèƒ½
        async function loadI18n(locale) {
            try {
                const res = await fetch(`/i18n/${locale}`);
                i18nData = await res.json();
                currentLocale = locale;
                localStorage.setItem('locale', locale);
                console.log(`Loaded i18n for ${locale}, keys: ${Object.keys(i18nData).length}`);
                
                // æ›´æ–°è¯­è¨€é€‰æ‹©å™¨
                document.getElementById('language-select').value = locale;
                
                // é‡æ–°æ¸²æŸ“é…ç½®
                if (Object.keys(configStructure).length > 0) {
                    renderConfig();
                }
            } catch (e) {
                console.error('Failed to load i18n:', e);
            }
        }

        function changeLanguage(locale) {
            loadI18n(locale);
        }

        function t(key) {
            // ç¿»è¯‘å‡½æ•°ï¼šå°è¯•ä» i18n æ•°æ®ä¸­è·å–ç¿»è¯‘
            if (i18nData[key]) {
                return i18nData[key];
            }
            // å¦‚æœæ²¡æœ‰æ‰¾åˆ°ï¼Œè¿”å›åŸå§‹ key
            return key;
        }

        function getParamDisplayName(section, key) {
            // å¦‚æœsectionä¸ºç©ºï¼Œè¯´æ˜è¿™æ˜¯é¡¶å±‚å‚æ•°ï¼Œç›´æ¥è¿”å›ç©ºå­—ç¬¦ä¸²ï¼ˆå› ä¸ºsectionåç§°å·²ç»åŒ…å«äº†å‚æ•°åï¼‰
            if (!section) {
                return '';
            }
            
            // å¸¸è§å‚æ•°çš„ä¸­æ–‡æ˜ å°„ï¼ˆè¡¥å……ç¼ºå¤±çš„ç¿»è¯‘ï¼‰
            const paramMap = {
                'force_simple_sort': 'å¼ºåˆ¶ç®€å•æ’åº',
                'kernel_size': 'å·ç§¯æ ¸å¤§å°',
                'mask_dilation_offset': 'é®ç½©æ‰©å¼ åç§»',
                'filter_text': 'è¿‡æ»¤æ–‡æœ¬ (Regex)',
                'no_text_lang_skip': 'ä¸è·³è¿‡ç›®æ ‡è¯­è¨€æ–‡æœ¬',
                'gpt_config': 'GPTé…ç½®æ–‡ä»¶è·¯å¾„',
                'high_quality_prompt_path': 'é«˜è´¨é‡ç¿»è¯‘æç¤ºè¯',
                'use_mocr_merge': 'ä½¿ç”¨MOCRåˆå¹¶',
                'use_hybrid_ocr': 'å¯ç”¨æ··åˆOCR',
                'secondary_ocr': 'å¤‡ç”¨OCR',
                'min_text_length': 'æœ€å°æ–‡æœ¬é•¿åº¦',
                'ignore_bubble': 'å¿½ç•¥éæ°”æ³¡æ–‡æœ¬',
                'prob': 'æ–‡æœ¬åŒºåŸŸæœ€ä½æ¦‚ç‡',
                'merge_gamma': 'åˆå¹¶-è·ç¦»å®¹å¿åº¦',
                'merge_sigma': 'åˆå¹¶-ç¦»ç¾¤å®¹å¿åº¦',
                'merge_edge_ratio_threshold': 'åˆå¹¶-è¾¹ç¼˜è·ç¦»æ¯”ä¾‹é˜ˆå€¼',
                'detection_size': 'æ£€æµ‹å¤§å°',
                'text_threshold': 'æ–‡æœ¬é˜ˆå€¼',
                'det_rotate': 'æ—‹è½¬å›¾åƒè¿›è¡Œæ£€æµ‹',
                'det_auto_rotate': 'æ—‹è½¬å›¾åƒä»¥ä¼˜å…ˆæ£€æµ‹å‚ç›´æ–‡æœ¬è¡Œ',
                'det_invert': 'åè½¬å›¾åƒé¢œè‰²è¿›è¡Œæ£€æµ‹',
                'det_gamma_correct': 'åº”ç”¨ä¼½é©¬æ ¡æ­£è¿›è¡Œæ£€æµ‹',
                'use_yolo_obb': 'å¯ç”¨YOLOè¾…åŠ©æ£€æµ‹',
                'yolo_obb_conf': 'YOLOç½®ä¿¡åº¦é˜ˆå€¼',
                'yolo_obb_iou': 'YOLOäº¤å‰æ¯”(IoU)',
                'yolo_obb_overlap_threshold': 'YOLOè¾…åŠ©æ£€æµ‹é‡å ç‡åˆ é™¤é˜ˆå€¼',
                'box_threshold': 'è¾¹ç•Œæ¡†ç”Ÿæˆé˜ˆå€¼',
                'unclip_ratio': 'Unclipæ¯”ä¾‹',
                'min_box_area_ratio': 'æœ€å°æ£€æµ‹æ¡†é¢ç§¯å æ¯”',
                'inpainting_size': 'ä¿®å¤å¤§å°',
                'inpainting_precision': 'ä¿®å¤ç²¾åº¦',
                'inpainting_split_ratio': 'æç«¯é•¿å®½æ¯”åˆ‡å‰²é˜ˆå€¼',
                'alignment': 'å¯¹é½æ–¹å¼',
                'disable_font_border': 'ç¦ç”¨å­—ä½“è¾¹æ¡†',
                'font_size': 'å­—ä½“å¤§å°',
                'font_size_offset': 'å­—ä½“å¤§å°åç§»',
                'font_size_minimum': 'æœ€å°å­—ä½“å¤§å°',
                'line_spacing': 'è¡Œé—´è·',
                'target_lang': 'ç›®æ ‡è¯­è¨€'
            };
            
            // å¦‚æœæœ‰ç›´æ¥æ˜ å°„ï¼Œä½¿ç”¨æ˜ å°„
            if (paramMap[key]) {
                return paramMap[key];
            }
            
            // å°è¯•å¤šç§å¯èƒ½çš„ç¿»è¯‘é”®
            const possibleKeys = [
                `label_${key}`,  // æ¡Œé¢ç‰ˆä½¿ç”¨ label_ å‰ç¼€
                `${section}.${key}`,
                `config.${section}.${key}`,
                key,
                `param.${key}`
            ];
            
            for (const k of possibleKeys) {
                const translated = t(k);
                if (translated !== k) {
                    return translated;
                }
            }
            
            // å¦‚æœéƒ½æ²¡æ‰¾åˆ°ï¼Œè¿”å›æ ¼å¼åŒ–çš„ keyï¼ˆé¦–å­—æ¯å¤§å†™ï¼Œä¸‹åˆ’çº¿è½¬ç©ºæ ¼ï¼‰
            return key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
        }

        function getSectionDisplayName(section) {
            // åŒºåŸŸåç§°æ˜ å°„
            const sectionMap = {
                'translator': 'ç¿»è¯‘å™¨',
                'detector': 'æ–‡æœ¬æ£€æµ‹å™¨',
                'ocr': 'OCRè¯†åˆ«',
                'inpainter': 'å›¾åƒä¿®å¤',
                'upscale': 'å›¾åƒè¶…åˆ†',
                'render': 'æ–‡æœ¬æ¸²æŸ“',
                'colorizer': 'å›¾åƒä¸Šè‰²',
                'cli': 'å‘½ä»¤è¡Œé€‰é¡¹',
                'textline_merge': 'æ–‡æœ¬è¡Œåˆå¹¶',
                'force_simple_sort': 'å…¨å±€å‚æ•° - å¼ºåˆ¶ç®€å•æ’åº',
                'kernel_size': 'å…¨å±€å‚æ•° - å·ç§¯æ ¸å¤§å°',
                'mask_dilation_offset': 'å…¨å±€å‚æ•° - é®ç½©æ‰©å¼ åç§»',
                'filter_text': 'å…¨å±€å‚æ•° - æ–‡æœ¬è¿‡æ»¤'
            };
            
            // å¦‚æœå½“å‰è¯­è¨€ä¸æ˜¯ä¸­æ–‡ï¼Œå°è¯•ä» i18n è·å–ç¿»è¯‘
            if (currentLocale !== 'zh_CN' && currentLocale !== 'zh_TW') {
                const possibleKeys = [
                    `section_${section}`,
                    `config.${section}`,
                    section
                ];
                
                for (const k of possibleKeys) {
                    const translated = t(k);
                    if (translated !== k) {
                        return translated;
                    }
                }
            }
            
            // ä½¿ç”¨æ˜ å°„æˆ–é¦–å­—æ¯å¤§å†™
            return sectionMap[section] || section.charAt(0).toUpperCase() + section.slice(1);
        }

        async function loadConfigStructure() {
            try {
                const res = await fetch('/config/structure', {
                    headers: { 'X-Admin-Token': adminToken }
                });
                configStructure = await res.json();
                
                // åŠ è½½å½“å‰è®¾ç½®
                const settingsRes = await fetch('/admin/settings', {
                    headers: { 'X-Admin-Token': adminToken }
                });
                const settings = await settingsRes.json();
                currentSettings.hidden_keys = settings.hidden_keys || [];
                currentSettings.readonly_keys = settings.readonly_keys || [];
                currentSettings.default_values = settings.default_values || {};
                
                renderConfig();
            } catch (e) {
                alert('åŠ è½½é…ç½®å¤±è´¥ï¼š' + e.message);
            }
        }

        function renderConfig() {
            const container = document.getElementById('config-sections');
            container.innerHTML = '';
            
            for (const [section, params] of Object.entries(configStructure)) {
                const sectionDiv = document.createElement('div');
                sectionDiv.className = 'config-section';
                
                const title = document.createElement('h2');
                title.textContent = getSectionDisplayName(section);
                title.title = `åŸå§‹åç§°: ${section}`;
                sectionDiv.appendChild(title);
                
                // æ£€æŸ¥æ˜¯å¦æ˜¯åŒ…å«å¤šä¸ªå‚æ•°çš„åŒºåŸŸï¼ˆè€Œä¸æ˜¯å•ä¸ªé¡¶å±‚å‚æ•°ï¼‰
                const isMultiParamSection = typeof params === 'object' && params.value === undefined;
                
                if (isMultiParamSection) {
                    // æ·»åŠ åŒºåŸŸæ§åˆ¶æŒ‰é’®ï¼ˆä»…å¯¹å¤šå‚æ•°åŒºåŸŸï¼‰
                    const controlsDiv = document.createElement('div');
                    controlsDiv.className = 'section-controls';
                    controlsDiv.innerHTML = `
                        <button class="secondary-btn" onclick="hideAllInSection('${section}')">ğŸ™ˆ å…¨éƒ¨éšè—</button>
                        <button class="secondary-btn" onclick="showAllInSection('${section}')">ğŸ‘ï¸ å…¨éƒ¨æ˜¾ç¤º</button>
                        <button class="secondary-btn" onclick="readonlyAllInSection('${section}')">ğŸ”’ å…¨éƒ¨åªè¯»</button>
                        <button class="secondary-btn" onclick="editableAllInSection('${section}')">âœï¸ å…¨éƒ¨å¯ç¼–è¾‘</button>
                    `;
                    sectionDiv.appendChild(controlsDiv);
                    
                    // æ·»åŠ è¡¨å¤´
                    const headerDiv = document.createElement('div');
                    headerDiv.className = 'param-list-header';
                    headerDiv.innerHTML = `
                        <div>å‚æ•°åç§°</div>
                        <div>ç±»å‹</div>
                        <div>å½“å‰å€¼ (ç‚¹å‡»ç¼–è¾‘)</div>
                        <div>æ§åˆ¶é€‰é¡¹</div>
                    `;
                    sectionDiv.appendChild(headerDiv);
                }
                
                const paramList = document.createElement('div');
                paramList.className = 'param-list';
                
                if (isMultiParamSection) {
                    // è¿™æ˜¯ä¸€ä¸ªåŒ…å«å¤šä¸ªå‚æ•°çš„åŒºåŸŸ
                    for (const [key, meta] of Object.entries(params)) {
                        const paramItem = createParamItem(section, key, meta);
                        paramList.appendChild(paramItem);
                    }
                } else {
                    // è¿™æ˜¯ä¸€ä¸ªé¡¶å±‚å‚æ•°ï¼ˆå•ä¸ªå€¼ï¼‰
                    const paramItem = createParamItem('', section, params);
                    paramList.appendChild(paramItem);
                }
                
                sectionDiv.appendChild(paramList);
                container.appendChild(sectionDiv);
            }
        }
        
        function hideAllInSection(section) {
            const params = configStructure[section];
            for (const [key, meta] of Object.entries(params)) {
                const fullKey = meta.full_key || `${section}.${key}`;
                if (!currentSettings.hidden_keys.includes(fullKey)) {
                    currentSettings.hidden_keys.push(fullKey);
                }
            }
            renderConfig();
        }
        
        function showAllInSection(section) {
            const params = configStructure[section];
            for (const [key, meta] of Object.entries(params)) {
                const fullKey = meta.full_key || `${section}.${key}`;
                currentSettings.hidden_keys = currentSettings.hidden_keys.filter(k => k !== fullKey);
            }
            renderConfig();
        }
        
        function readonlyAllInSection(section) {
            const params = configStructure[section];
            for (const [key, meta] of Object.entries(params)) {
                const fullKey = meta.full_key || `${section}.${key}`;
                if (!currentSettings.readonly_keys.includes(fullKey)) {
                    currentSettings.readonly_keys.push(fullKey);
                }
            }
            renderConfig();
        }
        
        function editableAllInSection(section) {
            const params = configStructure[section];
            for (const [key, meta] of Object.entries(params)) {
                const fullKey = meta.full_key || `${section}.${key}`;
                currentSettings.readonly_keys = currentSettings.readonly_keys.filter(k => k !== fullKey);
            }
            renderConfig();
        }

        function createParamItem(section, key, meta) {
            const div = document.createElement('div');
            div.className = 'param-item';
            
            const fullKey = meta.full_key || `${section}.${key}`;
            
            // å‚æ•°åï¼ˆä½¿ç”¨ç¿»è¯‘ï¼‰
            const nameDiv = document.createElement('div');
            nameDiv.className = 'param-name';
            const displayName = getParamDisplayName(section, key);
            nameDiv.textContent = displayName;
            nameDiv.title = `${fullKey}\nåŸå§‹åç§°: ${key}`;
            
            // ç±»å‹
            const typeDiv = document.createElement('div');
            typeDiv.className = 'param-type';
            typeDiv.textContent = `ç±»å‹: ${meta.type}`;
            
            // å½“å‰å€¼ï¼ˆå¯ç‚¹å‡»ç¼–è¾‘æˆ–ä¸‹æ‹‰é€‰æ‹©ï¼‰
            const valueDiv = document.createElement('div');
            const displayValue = currentSettings.default_values[fullKey] !== undefined 
                ? currentSettings.default_values[fullKey] 
                : meta.value;
            
            // å¸ƒå°”å€¼ï¼šä½¿ç”¨ä¸‹æ‹‰æ¡†
            if (meta.type === 'bool') {
                const select = document.createElement('select');
                select.className = 'param-value-select';
                select.style.cssText = 'width: 100%; padding: 6px 10px; border: 1px solid #CFD8DC; border-radius: 4px; font-size: 13px; cursor: pointer;';
                
                ['true', 'false'].forEach(opt => {
                    const option = document.createElement('option');
                    option.value = opt;
                    option.textContent = opt === 'true' ? 'True (æ˜¯)' : 'False (å¦)';
                    if ((opt === 'true' && displayValue === true) || (opt === 'false' && displayValue === false)) {
                        option.selected = true;
                    }
                    select.appendChild(option);
                });
                
                select.onchange = () => {
                    currentSettings.default_values[fullKey] = select.value === 'true';
                };
                
                valueDiv.appendChild(select);
            }
            // å¦‚æœæœ‰é€‰é¡¹åˆ—è¡¨ï¼Œåˆ›å»ºä¸‹æ‹‰æ¡†
            else if (meta.options && Array.isArray(meta.options)) {
                const select = document.createElement('select');
                select.className = 'param-value-select';
                select.style.cssText = 'width: 100%; padding: 6px 10px; border: 1px solid #CFD8DC; border-radius: 4px; font-size: 13px; cursor: pointer;';
                
                // ä¸ºå­—ä½“å’Œæç¤ºè¯æ·»åŠ å®æ—¶åˆ·æ–°åŠŸèƒ½
                if (key === 'font_path' || key === 'high_quality_prompt_path') {
                    select.onfocus = async () => {
                        const currentValue = select.value;
                        // é‡æ–°è·å–æœ€æ–°åˆ—è¡¨
                        try {
                            const res = await fetch('/config/options');
                            const options = await res.json();
                            const newOptions = options[key] || [];
                            
                            // æ¸…ç©ºå¹¶é‡æ–°å¡«å……
                            select.innerHTML = '';
                            newOptions.forEach(opt => {
                                const option = document.createElement('option');
                                option.value = opt;
                                option.textContent = opt;
                                select.appendChild(option);
                            });
                            
                            // æ¢å¤ä¹‹å‰çš„å€¼
                            if (newOptions.includes(currentValue)) {
                                select.value = currentValue;
                            }
                        } catch (e) {
                            console.error('Failed to refresh options:', e);
                        }
                    };
                }
                
                meta.options.forEach(opt => {
                    const option = document.createElement('option');
                    option.value = opt;
                    option.textContent = opt;
                    if (opt === displayValue) {
                        option.selected = true;
                    }
                    select.appendChild(option);
                });
                
                select.onchange = () => {
                    currentSettings.default_values[fullKey] = select.value;
                    
                    // å¦‚æœæ˜¯è¶…åˆ†æ¨¡å‹ï¼Œè§¦å‘è¶…åˆ†å€ç‡çš„æ›´æ–°
                    if (key === 'upscaler') {
                        updateUpscaleRatioOptionsInAdmin(select.value);
                    }
                };
                
                valueDiv.appendChild(select);
            } else {
                // æ™®é€šæ–‡æœ¬å€¼ï¼Œå¯ç‚¹å‡»ç¼–è¾‘
                valueDiv.className = 'param-value';
                valueDiv.textContent = JSON.stringify(displayValue);
                valueDiv.title = 'ç‚¹å‡»ç¼–è¾‘å½“å‰å€¼\nåŸå§‹å€¼: ' + JSON.stringify(meta.value);
                valueDiv.onclick = () => editParamValue(fullKey, displayValue, valueDiv, meta.options);
            }
            
            // æ§åˆ¶é€‰é¡¹
            const controlsDiv = document.createElement('div');
            controlsDiv.className = 'param-controls';
            
            const hiddenLabel = document.createElement('label');
            const hiddenCheck = document.createElement('input');
            hiddenCheck.type = 'checkbox';
            hiddenCheck.checked = currentSettings.hidden_keys.includes(fullKey);
            hiddenCheck.onchange = () => {
                if (hiddenCheck.checked) {
                    if (!currentSettings.hidden_keys.includes(fullKey)) {
                        currentSettings.hidden_keys.push(fullKey);
                    }
                } else {
                    currentSettings.hidden_keys = currentSettings.hidden_keys.filter(k => k !== fullKey);
                }
            };
            hiddenLabel.appendChild(hiddenCheck);
            hiddenLabel.appendChild(document.createTextNode('éšè—'));
            
            const readonlyLabel = document.createElement('label');
            const readonlyCheck = document.createElement('input');
            readonlyCheck.type = 'checkbox';
            readonlyCheck.checked = currentSettings.readonly_keys.includes(fullKey);
            readonlyCheck.onchange = () => {
                if (readonlyCheck.checked) {
                    if (!currentSettings.readonly_keys.includes(fullKey)) {
                        currentSettings.readonly_keys.push(fullKey);
                    }
                } else {
                    currentSettings.readonly_keys = currentSettings.readonly_keys.filter(k => k !== fullKey);
                }
            };
            readonlyLabel.appendChild(readonlyCheck);
            readonlyLabel.appendChild(document.createTextNode('åªè¯»'));
            
            controlsDiv.appendChild(hiddenLabel);
            controlsDiv.appendChild(readonlyLabel);
            
            div.appendChild(nameDiv);
            div.appendChild(typeDiv);
            div.appendChild(valueDiv);
            div.appendChild(controlsDiv);
            
            // æ ¹æ®çŠ¶æ€æ·»åŠ æ ·å¼
            if (currentSettings.hidden_keys.includes(fullKey)) {
                div.classList.add('hidden');
            }
            if (currentSettings.readonly_keys.includes(fullKey)) {
                div.classList.add('readonly');
            }
            
            return div;
        }

        function editParamValue(fullKey, currentValue, valueDiv) {
            // åˆ›å»ºè¾“å…¥æ¡†
            const input = document.createElement('input');
            input.className = 'param-value-edit';
            input.value = JSON.stringify(currentValue);
            
            // æ›¿æ¢æ˜¾ç¤ºå…ƒç´ 
            const parent = valueDiv.parentElement;
            parent.replaceChild(input, valueDiv);
            parent.classList.add('editing');
            input.focus();
            input.select();
            
            // ä¿å­˜å‡½æ•°
            const save = () => {
                try {
                    const newValue = input.value.trim();
                    if (newValue) {
                        // å°è¯•è§£æä¸º JSON
                        try {
                            currentSettings.default_values[fullKey] = JSON.parse(newValue);
                        } catch (e) {
                            // å¦‚æœä¸æ˜¯æœ‰æ•ˆçš„ JSONï¼Œä½œä¸ºå­—ç¬¦ä¸²å¤„ç†
                            currentSettings.default_values[fullKey] = newValue;
                        }
                    } else {
                        delete currentSettings.default_values[fullKey];
                    }
                    
                    // æ¢å¤æ˜¾ç¤º
                    valueDiv.textContent = newValue || JSON.stringify(currentValue);
                    parent.replaceChild(valueDiv, input);
                    parent.classList.remove('editing');
                } catch (e) {
                    alert('ä¿å­˜å¤±è´¥ï¼š' + e.message);
                }
            };
            
            // å–æ¶ˆå‡½æ•°
            const cancel = () => {
                parent.replaceChild(valueDiv, input);
                parent.classList.remove('editing');
            };
            
            // äº‹ä»¶ç›‘å¬
            input.onblur = save;
            input.onkeydown = (e) => {
                if (e.key === 'Enter') {
                    save();
                } else if (e.key === 'Escape') {
                    cancel();
                }
            };
        }

        function updateUpscaleRatioOptionsInAdmin(upscaler) {
            // æŸ¥æ‰¾ upscale_ratio çš„ä¸‹æ‹‰æ¡†
            const ratioSelects = document.querySelectorAll('select.param-value-select');
            let ratioSelect = null;
            
            for (const select of ratioSelects) {
                const paramItem = select.closest('.param-item');
                if (paramItem && paramItem.querySelector('.param-name')?.title?.includes('upscale.upscale_ratio')) {
                    ratioSelect = select;
                    break;
                }
            }
            
            if (!ratioSelect) return;
            
            const currentValue = ratioSelect.value;
            ratioSelect.innerHTML = '';
            
            if (upscaler === 'realcugan') {
                // æ˜¾ç¤º Real-CUGAN æ¨¡å‹åˆ—è¡¨
                const realcuganModels = [
                    'ä¸ä½¿ç”¨',
                    '2x-conservative', '2x-conservative-pro', '2x-no-denoise',
                    '2x-denoise1x', '2x-denoise2x', '2x-denoise3x', '2x-denoise3x-pro',
                    '3x-conservative', '3x-conservative-pro', '3x-no-denoise', '3x-no-denoise-pro',
                    '3x-denoise3x', '3x-denoise3x-pro',
                    '4x-conservative', '4x-no-denoise', '4x-denoise3x'
                ];
                
                realcuganModels.forEach(opt => {
                    const option = document.createElement('option');
                    option.value = opt;
                    option.textContent = opt;
                    ratioSelect.appendChild(option);
                });
                
                // å°è¯•æ¢å¤ä¹‹å‰çš„å€¼
                if (realcuganModels.includes(currentValue)) {
                    ratioSelect.value = currentValue;
                } else {
                    ratioSelect.value = 'ä¸ä½¿ç”¨';
                }
            } else {
                // æ˜¾ç¤ºæ™®é€šå€ç‡é€‰é¡¹
                const ratioOptions = ['ä¸ä½¿ç”¨', '2', '3', '4'];
                
                ratioOptions.forEach(opt => {
                    const option = document.createElement('option');
                    option.value = opt;
                    option.textContent = opt;
                    ratioSelect.appendChild(option);
                });
                
                // å°è¯•æ¢å¤ä¹‹å‰çš„å€¼
                if (ratioOptions.includes(currentValue)) {
                    ratioSelect.value = currentValue;
                } else {
                    ratioSelect.value = 'ä¸ä½¿ç”¨';
                }
            }
            
            // æ›´æ–° currentSettings
            currentSettings.default_values['upscale.upscale_ratio'] = ratioSelect.value;
        }

        async function saveAllSettings() {
            // å¤„ç†è¶…åˆ†æ¨¡å‹å’Œå€ç‡çš„å…³ç³»
            const upscalerValue = currentSettings.default_values['upscale.upscaler'];
            const upscaleRatioValue = currentSettings.default_values['upscale.upscale_ratio'];
            
            if (upscalerValue === 'realcugan' && upscaleRatioValue) {
                // å¦‚æœé€‰æ‹©äº† realcuganï¼Œupscale_ratio çš„å€¼å®é™…ä¸Šæ˜¯ realcugan_model
                if (upscaleRatioValue === 'ä¸ä½¿ç”¨') {
                    currentSettings.default_values['upscale.upscale_ratio'] = null;
                    currentSettings.default_values['upscale.realcugan_model'] = null;
                } else {
                    currentSettings.default_values['upscale.realcugan_model'] = upscaleRatioValue;
                    currentSettings.default_values['upscale.upscale_ratio'] = null;
                }
            } else if (upscaleRatioValue) {
                // å…¶ä»–è¶…åˆ†æ¨¡å‹ï¼Œä½¿ç”¨æ™®é€šå€ç‡
                if (upscaleRatioValue === 'ä¸ä½¿ç”¨') {
                    currentSettings.default_values['upscale.upscale_ratio'] = null;
                } else {
                    currentSettings.default_values['upscale.upscale_ratio'] = parseInt(upscaleRatioValue) || upscaleRatioValue;
                }
                currentSettings.default_values['upscale.realcugan_model'] = null;
            }
            
            try {
                const res = await fetch('/admin/settings/parameter-visibility', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Admin-Token': adminToken
                    },
                    body: JSON.stringify(currentSettings)
                });
                
                if (res.ok) {
                    alert('è®¾ç½®å·²ä¿å­˜ï¼\n\nå·²ä¿å­˜ï¼š\n- éšè—å‚æ•°: ' + currentSettings.hidden_keys.length + ' ä¸ª\n- åªè¯»å‚æ•°: ' + currentSettings.readonly_keys.length + ' ä¸ª\n- è‡ªå®šä¹‰é»˜è®¤å€¼: ' + Object.keys(currentSettings.default_values).length + ' ä¸ª');
                    // é‡æ–°åŠ è½½ä»¥æ˜¾ç¤ºæ›´æ–°åçš„å€¼
                    await loadConfigStructure();
                } else {
                    alert('ä¿å­˜å¤±è´¥');
                }
            } catch (e) {
                alert('ä¿å­˜å¤±è´¥ï¼š' + e.message);
            }
        }

        // é¡µé¢åŠ è½½æ—¶æ‰§è¡Œ
        if (!adminToken) {
            alert('è¯·å…ˆç™»å½•ç®¡ç†å‘˜é¢æ¿');
            window.location.href = '/admin';
        } else {
            // å…ˆåŠ è½½ i18nï¼Œå†åŠ è½½é…ç½®
            loadI18n(currentLocale).then(() => {
                loadConfigStructure();
            });
        }
    </script>
</body>
</html>
