<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manga Translator - Admin Panel</title>
    <link rel="stylesheet" href="/static/style.css">
    <style>
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            background-color: #F5F7FA;
        }
        .login-box {
            background: white;
            padding: 40px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            width: 400px;
        }
        .login-box h2 {
            margin-bottom: 20px;
            color: #2196F3;
        }
        .login-box input {
            width: 100%;
            padding: 10px;
            margin-bottom: 15px;
            border: 1px solid #CFD8DC;
            border-radius: 4px;
        }
        .admin-panel {
            display: none;
        }
        .admin-section {
            background: white;
            padding: 20px;
            margin: 20px;
            border-radius: 8px;
            border: 1px solid #E0E0E0;
        }
        .admin-section h3 {
            color: #2196F3;
            margin-bottom: 15px;
        }
        .upload-area {
            border: 2px dashed #CFD8DC;
            padding: 20px;
            text-align: center;
            border-radius: 4px;
            margin: 10px 0;
        }
        .file-list-admin {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #E0E0E0;
            border-radius: 4px;
            padding: 10px;
            margin-top: 10px;
        }
        /* 确保管理面板可以滚动 */
        #admin-panel .app-container {
            height: 100vh;
            overflow: hidden;
        }
        #admin-panel main {
            overflow-y: auto !important;
            overflow-x: hidden;
        }
        /* 确保所有区域都可见 */
        .admin-section {
            flex-shrink: 0;
        }
    </style>
</head>
<body>
    <!-- Setup Screen (First Time) -->
    <div id="setup-screen" class="login-container" style="display: none;">
        <div class="login-box">
            <h2>首次设置</h2>
            <p style="color: #666; margin-bottom: 20px;">请设置管理员密码（至少6位）</p>
            <input type="password" id="setup-password" placeholder="请输入密码">
            <input type="password" id="setup-password-confirm" placeholder="请再次输入密码">
            <button onclick="setupPassword()" class="primary-btn large-btn">设置密码</button>
            <div id="setup-error" style="color: red; margin-top: 10px;"></div>
        </div>
    </div>

    <!-- Login Screen -->
    <div id="login-screen" class="login-container">
        <div class="login-box">
            <h2>管理员登录</h2>
            <input type="password" id="admin-password" placeholder="请输入管理员密码">
            <button onclick="login()" class="primary-btn large-btn">登录</button>
            <div id="login-error" style="color: red; margin-top: 10px;"></div>
        </div>
    </div>

    <!-- Admin Panel -->
    <div id="admin-panel" class="admin-panel">
        <div class="app-container">
            <header class="app-header">
                <h1>Manga Translator - 管理面板</h1>
                <div class="header-controls">
                    <select id="language-select" class="language-select" onchange="changeLanguage(this.value)">
                        <option value="zh_CN">简体中文</option>
                        <option value="zh_TW">繁體中文</option>
                        <option value="en_US">English</option>
                        <option value="ja_JP">日本語</option>
                        <option value="ko_KR">한국어</option>
                        <option value="es_ES">Español</option>
                    </select>
                    <button onclick="logout()" class="secondary-btn">退出登录</button>
                </div>
            </header>

            <main style="padding: 20px; overflow-y: auto; height: calc(100vh - 60px); max-height: calc(100vh - 60px);">
                <!-- Announcement Management -->
                <div class="admin-section">
                    <h3>公告管理</h3>
                    <p>设置用户端显示的公告信息：</p>
                    <div class="checkbox-wrapper">
                        <input type="checkbox" id="announcement-enabled">
                        <label>启用公告</label>
                    </div>
                    <div style="margin-top: 15px;">
                        <label>公告类型：</label>
                        <select id="announcement-type" style="padding: 8px; margin-left: 10px;">
                            <option value="info">信息（蓝色）</option>
                            <option value="warning">警告（黄色）</option>
                            <option value="error">错误（红色）</option>
                        </select>
                    </div>
                    <div style="margin-top: 15px;">
                        <label>公告内容：</label>
                        <textarea id="announcement-message" style="width: 100%; min-height: 80px; padding: 8px; margin-top: 5px; border: 1px solid #CFD8DC; border-radius: 4px;" placeholder="输入公告内容..."></textarea>
                    </div>
                    <button onclick="saveAnnouncement()" class="primary-btn" style="margin-top: 15px;">保存公告</button>
                </div>

                <!-- Active Tasks -->
                <div class="admin-section">
                    <h3>活动任务管理</h3>
                    <p>当前正在运行的翻译任务：</p>
                    <button onclick="refreshTasks()" class="secondary-btn">刷新任务列表</button>
                    <div id="active-tasks-list" style="margin-top: 15px;">
                        <p style="color: #666;">加载中...</p>
                    </div>
                </div>

                <!-- Logs Viewer -->
                <div class="admin-section">
                    <h3>日志查看器</h3>
                    <div style="margin-bottom: 15px;">
                        <button onclick="refreshLogs()" class="secondary-btn">刷新日志</button>
                        <button onclick="exportLogs()" class="secondary-btn">导出日志</button>
                        <select id="log-level-filter" onchange="refreshLogs()" style="margin-left: 10px; padding: 8px;">
                            <option value="">所有级别</option>
                            <option value="DEBUG">DEBUG</option>
                            <option value="INFO">INFO</option>
                            <option value="WARNING">WARNING</option>
                            <option value="ERROR">ERROR</option>
                        </select>
                        <input type="number" id="log-limit" value="200" min="50" max="1000" step="50" 
                               style="margin-left: 10px; padding: 8px; width: 100px;" 
                               placeholder="日志数量">
                    </div>
                    <div id="logs-container" style="background: #263238; color: #ADBAC7; padding: 15px; border-radius: 4px; max-height: 500px; overflow-y: auto; font-family: 'Consolas', 'Monaco', monospace; font-size: 13px; line-height: 1.6;">
                        <p>加载中...</p>
                    </div>
                </div>

                <!-- Server Config -->
                <div class="admin-section">
                    <h3>服务器配置</h3>
                    <div id="config-path-info" style="background: #E3F2FD; padding: 10px; border-radius: 4px; margin-bottom: 15px; font-size: 13px;">
                        <strong>📁 配置文件路径：</strong><br>
                        <code id="admin-config-path" style="background: white; padding: 2px 6px; border-radius: 3px;">加载中...</code>
                        <span id="config-status" style="margin-left: 10px;"></span>
                    </div>
                    <div class="form-group">
                        <label>最大并发任务数：</label>
                        <input type="number" id="max-concurrent" min="1" max="10" value="3">
                    </div>
                    <button onclick="saveServerConfig()" class="primary-btn">保存配置</button>
                </div>

                <!-- Change Admin Password -->
                <div class="admin-section">
                    <h3>更改管理员密码</h3>
                    <p>修改管理面板的登录密码：</p>
                    <div class="form-group">
                        <label>当前密码</label>
                        <input type="password" id="old-password" placeholder="请输入当前密码" style="width: 100%; padding: 8px; border: 1px solid #CFD8DC; border-radius: 4px;">
                    </div>
                    <div class="form-group" style="margin-top: 15px;">
                        <label>新密码（至少6位）</label>
                        <input type="password" id="new-password" placeholder="请输入新密码" style="width: 100%; padding: 8px; border: 1px solid #CFD8DC; border-radius: 4px;">
                    </div>
                    <div class="form-group" style="margin-top: 15px;">
                        <label>确认新密码</label>
                        <input type="password" id="new-password-confirm" placeholder="请再次输入新密码" style="width: 100%; padding: 8px; border: 1px solid #CFD8DC; border-radius: 4px;">
                    </div>
                    <button onclick="changeAdminPassword()" class="primary-btn" style="margin-top: 15px;">更改密码</button>
                    <div id="change-password-message" style="margin-top: 10px;"></div>
                </div>

                <!-- Permissions -->
                <div class="admin-section">
                    <h3>权限控制</h3>
                    <p>控制管理端的上传和删除权限：</p>
                    <div class="checkbox-wrapper">
                        <input type="checkbox" id="perm-upload-fonts" checked>
                        <label>允许上传字体</label>
                    </div>
                    <div class="checkbox-wrapper">
                        <input type="checkbox" id="perm-delete-fonts" checked>
                        <label>允许删除字体</label>
                    </div>
                    <div class="checkbox-wrapper">
                        <input type="checkbox" id="perm-upload-prompts" checked>
                        <label>允许上传提示词</label>
                    </div>
                    <div class="checkbox-wrapper">
                        <input type="checkbox" id="perm-delete-prompts" checked>
                        <label>允许删除提示词</label>
                    </div>
                    <button onclick="savePermissions()" class="primary-btn">保存权限设置</button>
                </div>

                <!-- Upload Limits -->
                <div class="admin-section">
                    <h3>上传限制</h3>
                    <p>限制用户上传的图片大小和数量（0表示不限制）：</p>
                    <div class="form-group">
                        <label>单张图片最大大小（MB）</label>
                        <input type="number" id="max-image-size" min="0" step="0.1" value="10" style="width: 100%; padding: 8px; border: 1px solid #CFD8DC; border-radius: 4px;">
                        <small style="color: #666;">设置为0表示不限制大小，支持小数（如0.5表示500KB）</small>
                    </div>
                    <div class="form-group" style="margin-top: 15px;">
                        <label>一次最多上传图片数量</label>
                        <input type="number" id="max-images-batch" min="0" step="1" value="50" style="width: 100%; padding: 8px; border: 1px solid #CFD8DC; border-radius: 4px;">
                        <small style="color: #666;">设置为0表示不限制数量</small>
                    </div>
                    <button onclick="saveUploadLimits()" class="primary-btn" style="margin-top: 15px;">保存上传限制</button>
                </div>

                <!-- User Access Control -->
                <div class="admin-section">
                    <h3>用户端访问控制</h3>
                    <p>设置用户端是否需要密码才能访问：</p>
                    <div class="checkbox-wrapper">
                        <input type="checkbox" id="require-user-password">
                        <label>启用用户端密码保护</label>
                    </div>
                    <div class="form-group" style="margin-top: 15px;">
                        <label>用户端密码</label>
                        <input type="password" id="user-password" placeholder="留空表示不需要密码" style="width: 100%; padding: 8px; border: 1px solid #CFD8DC; border-radius: 4px;">
                        <small style="color: #666;">用户访问主页时需要输入此密码</small>
                    </div>
                    <button onclick="saveUserAccess()" class="primary-btn" style="margin-top: 15px;">保存访问控制</button>
                </div>

                <!-- API Key Policy -->
                <div class="admin-section">
                    <h3>API Key 策略</h3>
                    <p>控制用户如何使用 API Keys：</p>
                    <div class="checkbox-wrapper">
                        <input type="checkbox" id="show-env-to-users">
                        <label>在用户端显示 API Keys 编辑功能</label>
                    </div>
                    <div class="checkbox-wrapper">
                        <input type="checkbox" id="policy-require-user-keys">
                        <label>强制用户提供自己的 API Key</label>
                    </div>
                    <div class="checkbox-wrapper">
                        <input type="checkbox" id="policy-allow-server-keys" checked>
                        <label>允许使用服务器的 API Key</label>
                    </div>
                    <div class="checkbox-wrapper">
                        <input type="checkbox" id="policy-save-user-keys">
                        <label>将用户的 API Key 保存到服务器 .env</label>
                    </div>
                    <small style="color: #666; display: block; margin-top: 10px;">
                        注意：如果强制用户提供 API Key 且不允许使用服务器 Key，用户必须输入才能翻译
                    </small>
                    <button onclick="saveApiKeyPolicy()" class="primary-btn">保存 API Key 策略</button>
                </div>

                <!-- Server API Keys -->
                <div class="admin-section">
                    <h3>服务器 API Keys 管理</h3>
                    <p>设置服务器端的 API Keys（保存到 .env 文件）：</p>
                    <div id="server-api-keys">
                        <!-- 动态生成 -->
                    </div>
                    <button onclick="saveServerApiKeys()" class="primary-btn">保存服务器 API Keys</button>
                </div>

                <!-- Visible Settings -->
                <div class="admin-section">
                    <h3>用户端可见设置</h3>
                    <p>选择用户端可以看到和修改的配置区域：</p>
                    <div class="checkbox-wrapper">
                        <input type="checkbox" id="visible-translator" value="translator" checked>
                        <label>翻译器设置</label>
                    </div>
                    <div class="checkbox-wrapper">
                        <input type="checkbox" id="visible-detector" value="detector">
                        <label>检测器设置</label>
                    </div>
                    <div class="checkbox-wrapper">
                        <input type="checkbox" id="visible-render" value="render" checked>
                        <label>渲染设置</label>
                    </div>
                    <div class="checkbox-wrapper">
                        <input type="checkbox" id="visible-ocr" value="ocr">
                        <label>OCR设置</label>
                    </div>
                    <button onclick="saveVisibleSettings()" class="primary-btn">保存设置</button>
                    <hr style="margin: 15px 0; border: none; border-top: 1px solid #E0E0E0;">
                    <p style="margin-top: 15px;"><strong>精确参数控制：</strong></p>
                    <p style="color: #666; font-size: 13px;">需要精确控制每个参数的可见性、只读状态和默认值？</p>
                    <button onclick="window.location.href='/static/admin_config.html'" class="secondary-btn" style="margin-top: 10px;">
                        ⚙️ 打开高级参数配置
                    </button>
                </div>

                <!-- Allowed Translators -->
                <div class="admin-section">
                    <h3>允许的翻译器</h3>
                    <p>选择用户端可以使用的翻译器（不选=全部允许）：</p>
                    <div id="translator-checkboxes" style="max-height: 300px; overflow-y: auto;">
                        <!-- 动态生成 -->
                    </div>
                    <button onclick="saveAllowedTranslators()" class="primary-btn">保存翻译器设置</button>
                </div>

                <!-- Allowed Languages -->
                <div class="admin-section">
                    <h3>允许的目标语言</h3>
                    <p>选择用户端可以使用的目标语言（不选=全部允许）：</p>
                    <div id="language-checkboxes" style="max-height: 300px; overflow-y: auto;">
                        <!-- 动态生成 -->
                    </div>
                    <button onclick="saveAllowedLanguages()" class="primary-btn">保存语言设置</button>
                </div>

                <!-- Allowed Workflows -->
                <div class="admin-section">
                    <h3>允许的翻译流程</h3>
                    <p>选择用户端可以使用的翻译流程（不选=全部允许）：</p>
                    <div id="workflow-checkboxes">
                        <!-- 动态生成 -->
                    </div>
                    <button onclick="saveAllowedWorkflows()" class="primary-btn">保存流程设置</button>
                </div>

                <!-- Font Upload -->
                <div class="admin-section">
                    <h3>字体管理</h3>
                    <div class="upload-area">
                        <input type="file" id="font-upload" accept=".ttf,.otf,.ttc" style="display: none;">
                        <button onclick="document.getElementById('font-upload').click()" class="secondary-btn">上传字体文件</button>
                        <p>支持 TTF, OTF, TTC 格式，上传到 fonts 目录</p>
                    </div>
                    <div id="font-list" class="file-list-admin"></div>
                </div>

                <!-- Prompt Upload -->
                <div class="admin-section">
                    <h3>高质量翻译提示词管理</h3>
                    <div class="upload-area">
                        <input type="file" id="prompt-upload" accept=".json" style="display: none;">
                        <button onclick="document.getElementById('prompt-upload').click()" class="secondary-btn">上传提示词文件</button>
                        <p>必须是 JSON 格式，上传到 dict 目录</p>
                        <small style="color: #666;">注意：system_prompt_hq.json 和 system_prompt_line_break.json 是系统文件，不会显示</small>
                    </div>
                    <div id="prompt-list" class="file-list-admin"></div>
                </div>
            </main>
        </div>
    </div>

    <script src="/static/admin.js"></script>
</body>
</html>
